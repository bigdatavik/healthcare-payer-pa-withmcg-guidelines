bundle:
  name: healthcare-payer-pa-withmcg-guidelines

# Workspace configuration
workspace:
  host: https://adb-984752964297111.11.azuredatabricks.net
  profile: DEFAULT_azure

# Target environments
targets:
  dev:
    mode: development
    default: true
    variables:
      environment: dev
      catalog_name: healthcare_payer_pa_withmcg_guidelines_dev
      schema_name: main
      warehouse_id: 148ccb90800933a1
      vector_endpoint: one-env-shared-endpoint-2

  prod:
    mode: production
    variables:
      environment: prod
      catalog_name: healthcare_payer_pa_withmcg_guidelines_prod
      schema_name: main
      warehouse_id: 148ccb90800933a1
      vector_endpoint: one-env-shared-endpoint-2

# Variables
variables:
  environment:
    description: "Environment (dev/prod)"
  catalog_name:
    description: Unity Catalog name for PA data
  schema_name:
    description: Schema name within catalog
  warehouse_id:
    description: SQL Warehouse ID for queries
  vector_endpoint:
    description: Shared Vector Search endpoint for both clinical and guidelines indexes

# Resources
resources:
  # Setup Job - Creates all resources
  jobs:
    pa_setup_job:
      name: pa_setup_${var.environment}
      job_clusters:
        - job_cluster_key: main_cluster
          new_cluster:
            spark_version: "16.4.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 2
            data_security_mode: "USER_ISOLATION" # Enable Unity Catalog
            custom_tags:
              project: "prior-authorization"
              environment: "${bundle.target}"

      tasks:
        - task_key: cleanup
          job_cluster_key: main_cluster
          notebook_task:
            notebook_path: ./setup/00_CLEANUP.py
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}
          timeout_seconds: 600

        - task_key: create_catalog_schema
          job_cluster_key: main_cluster
          depends_on:
            - task_key: cleanup
          notebook_task:
            notebook_path: ./setup/01_create_catalog_schema.py
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}
          timeout_seconds: 600

        - task_key: generate_clinical_documents
          job_cluster_key: main_cluster
          depends_on:
            - task_key: create_catalog_schema
          notebook_task:
            notebook_path: ./setup/02_generate_clinical_documents.py
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}
          timeout_seconds: 1200

        - task_key: chunk_clinical_records
          job_cluster_key: main_cluster
          depends_on:
            - task_key: generate_clinical_documents
          notebook_task:
            notebook_path: ./setup/02a_chunk_clinical_records.py
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}
          timeout_seconds: 1200

        - task_key: generate_guidelines_documents
          job_cluster_key: main_cluster
          depends_on:
            - task_key: create_catalog_schema
          notebook_task:
            notebook_path: ./setup/03_generate_guidelines_documents.py
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}
          timeout_seconds: 1200

        - task_key: chunk_guidelines
          job_cluster_key: main_cluster
          depends_on:
            - task_key: generate_guidelines_documents
          notebook_task:
            notebook_path: ./setup/03a_chunk_guidelines.py
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}
          timeout_seconds: 1200

        - task_key: generate_pa_requests
          job_cluster_key: main_cluster
          depends_on:
            - task_key: chunk_clinical_records
            - task_key: chunk_guidelines
          notebook_task:
            notebook_path: ./setup/04_generate_pa_requests.py
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}
          timeout_seconds: 600

        - task_key: create_vector_index_clinical
          job_cluster_key: main_cluster
          depends_on:
            - task_key: chunk_clinical_records
          notebook_task:
            notebook_path: ./setup/05_create_vector_index_clinical.py
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}
              endpoint_name: ${var.vector_endpoint}
          timeout_seconds: 1800

        - task_key: create_vector_index_guidelines
          job_cluster_key: main_cluster
          depends_on:
            - task_key: chunk_guidelines
          notebook_task:
            notebook_path: ./setup/06_create_vector_index_guidelines.py
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}
              endpoint_name: ${var.vector_endpoint}
          timeout_seconds: 1800

        - task_key: uc_extract_criteria
          job_cluster_key: main_cluster
          depends_on:
            - task_key: create_catalog_schema
          notebook_task:
            notebook_path: ./setup/07c_uc_extract_criteria.py
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}
          timeout_seconds: 600

        - task_key: uc_check_mcg
          job_cluster_key: main_cluster
          depends_on:
            - task_key: chunk_guidelines
          notebook_task:
            notebook_path: ./setup/07d_uc_check_mcg.py
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}
          timeout_seconds: 600

        - task_key: uc_answer_mcg
          job_cluster_key: main_cluster
          depends_on:
            - task_key: create_catalog_schema
          notebook_task:
            notebook_path: ./setup/07e_uc_answer_mcg.py
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}
          timeout_seconds: 600

        - task_key: uc_explain_decision
          job_cluster_key: main_cluster
          depends_on:
            - task_key: create_catalog_schema
          notebook_task:
            notebook_path: ./setup/07f_uc_explain_decision.py
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}
          timeout_seconds: 600

        - task_key: test_agent_workflow
          job_cluster_key: main_cluster
          depends_on:
            - task_key: create_vector_index_clinical
            - task_key: create_vector_index_guidelines
            - task_key: uc_extract_criteria
            - task_key: uc_check_mcg
            - task_key: uc_answer_mcg
            - task_key: uc_explain_decision
          notebook_task:
            notebook_path: ./setup/08_test_agent_workflow.py
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}
          timeout_seconds: 600

        - task_key: create_genie_space
          job_cluster_key: main_cluster
          depends_on:
            - task_key: generate_pa_requests
          notebook_task:
            notebook_path: ./setup/09_create_genie_space.py
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}
          timeout_seconds: 600

  # Databricks App - Streamlit Dashboard
  apps:
    pa_dashboard:
      name: pa-dashboard-${bundle.target}
      description: "Prior Authorization AI Agent Dashboard - ${bundle.target}"
      source_code_path: ./dashboard
